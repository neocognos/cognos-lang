import "lib/exec.cog"
import "../lib/web_search.cog"

flow shell(command: String) -> String:
    "Run a shell command. Output limited to 50 lines."
    return __exec_shell__(f"{command} | head -50")

flow read_file(path: String) -> String:
    "Read the contents of a file"
    return read(file(path))

flow do_research(query: String) -> String:
    "Research a topic using web search + LLM synthesis"
    write(stdout, "  ğŸ“¡ Searching...\n")
    results = web_search(query, num_results=3)
    if results == "":
        return "Web search returned no results."
    write(stdout, "  ğŸ§  Synthesizing...\n")
    return think(f"Query: {query}\n\nSearch results:\n{results}", model="claude-sonnet-4-20250514", system="Summarize these search results clearly. Include source URLs.")

flow respond(input: String, tasks: Map) -> Map:
    "Handle a user message"
    response = think(input, model="claude-sonnet-4-20250514", system="Be concise and helpful. You have shell and file tools. Use them when needed.", tools=["shell", "read_file", "web_search"])
    if response.has_tool_calls:
        write(stdout, "ğŸ”§ Running tools...\n")
        executed = exec(response, tools=["shell", "read_file", "web_search"])
        final = think(f"User: {input}\nResults:\n{executed.content}", model="claude-sonnet-4-20250514", system="Answer concisely based on these results.")
        write(stdout, f"{final.content}\n")
    else:
        write(stdout, f"{response.content}\n")
    return tasks

flow main():
    write(stdout, "ğŸ¤– Assistant ready.\n")
    write(stdout, "Prefix with 'bg:' to run in background. 'status'/'cancel'/'exit' for control.\n\n")
    tasks = {}
    loop:
        write(stdout, "> ")
        if tasks.length == 0:
            input = read(stdin)
            if input == "exit" or input == "quit":
                break
            if input == "status":
                write(stdout, "No tasks running.\n")
            if input.starts_with("bg:"):
                query = input[3:].strip()
                handle = async do_research(query)
                tasks["research"] = handle
                write(stdout, f"âš¡ Research started. Keep talking.\n")
            if input != "status":
                if input.starts_with("bg:") == false:
                    tasks = respond(input, tasks)
        else:
            select:
                branch:
                    input = read(stdin)
                    if input == "exit" or input == "quit":
                        for name, handle in tasks:
                            cancel(handle)
                        break
                    if input == "status":
                        for name, handle in tasks:
                            write(stdout, f"  â³ {name}: running\n")
                    if input.starts_with("cancel "):
                        name = input[7:].strip()
                        try:
                            cancel(tasks[name])
                            tasks = remove(tasks, name)
                            write(stdout, f"ğŸ›‘ Cancelled '{name}'.\n")
                        catch err:
                            write(stdout, f"No task '{name}'.\n")
                    if input.starts_with("bg:"):
                        query = input[3:].strip()
                        handle = async do_research(query)
                        tasks["research"] = handle
                        write(stdout, f"âš¡ Research started. Keep talking.\n")
                    if input != "status":
                        if input.starts_with("cancel ") == false:
                            if input.starts_with("bg:") == false:
                                task_names = []
                                for name, handle in tasks:
                                    task_names = task_names + [name]
                                response = think(input, model="claude-sonnet-4-20250514", system=f"Be very concise. Tasks running: {task_names}.")
                                write(stdout, f"{response}\n")
                branch:
                    first_name = ""
                    first_handle = None
                    for name, handle in tasks:
                        if first_name == "":
                            first_name = name
                            first_handle = handle
                    result = await(first_handle)
                    write(stdout, f"\nâœ… '{first_name}' done:\n{result}\n")
                    tasks = remove(tasks, first_name)
    write(stdout, "Goodbye! ğŸ‘‹\n")
