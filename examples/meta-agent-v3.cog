# meta-agent-v3.cog — Scout → Architect → Execute
# Scout explores (agent mode). Architect generates a Python fix script. Execute runs it.

import "lib/exec.cog"

# --- Tool flows ---

flow shell(command: String) -> String:
    "Run a shell command and return stdout."
    return __exec_shell__(command)

flow read_file(path: String) -> String:
    "Read a file."
    return read_text(path)

flow read_lines(path: String, start: Int, end: Int) -> String:
    "Read specific lines from a file (1-indexed)."
    return __exec_shell__(f"sed -n '{start},{end}p' {path}")

flow search(pattern: String, path: String = ".") -> String:
    "Grep for a pattern in Python files."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && grep -rnE '{pattern}' {path} --include='*.py' | head -50")

flow find_files(pattern: String) -> String:
    "Find files matching a glob."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && find . -name '{pattern}' -not -path './.git/*' | head -30")

flow list_dir(path: String = ".") -> String:
    "List directory."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && ls -la {path}")

flow edit_file(path: String, old_text: String, new_text: String) -> String:
    "Replace old_text with new_text in a file."
    write_text("/tmp/cognos-old.txt", old_text)
    write_text("/tmp/cognos-new.txt", new_text)
    write_text("/tmp/cognos-edit.py", "import sys\nwith open(sys.argv[1]) as f: content = f.read()\nwith open('/tmp/cognos-old.txt') as f: old = f.read()\nwith open('/tmp/cognos-new.txt') as f: new = f.read()\nif old not in content:\n    print('ERROR: old_text not found in ' + sys.argv[1] + ' | Looking for: ' + repr(old[:200]))\nelse:\n    content = content.replace(old, new, 1)\n    with open(sys.argv[1], 'w') as f: f.write(content)\n    print('OK: edited ' + sys.argv[1])")
    result = __exec_shell__(f"python3 /tmp/cognos-edit.py {path}")
    if "ERROR" in result:
        log(f"edit_file failed: {result}")
    return result

flow git_diff() -> String:
    "Show git diff."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && git diff")

# --- Main ---

flow main():
    issue = shell("cat /tmp/cognos-issue.txt 2>/dev/null")
    repo_path = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    
    if issue.strip() == "":
        write(stdout, "No issue found.")
        return none
    
    shell(f"cd {repo_path} && git checkout -- . && git clean -fd 2>/dev/null")
    write(stdout, "Meta-agent v3: Scout → Architect → Execute")
    write(stdout, f"Repo: {repo_path}")
    
    # ========================================
    # PHASE 1: SCOUT (read-only agent mode)
    # ========================================
    write(stdout, "\n=== Phase 1: Scout ===")
    
    scout_system = f"You are investigating a bug. Find the exact code that needs to change.\n\nTools: search, read_lines, find_files, list_dir, shell.\nRepo: {repo_path}\n\nYou CANNOT edit files. Read only.\nWorkflow: search() to find files, read_lines(path, start, end) to see exact code.\nWhen you've found the bug, STOP and describe:\n- Which file (absolute path)\n- Which lines\n- The exact current code\n- What's wrong\n- What to change"
    
    scout_prompt = f"Find the bug:\n\n{issue}\n\nRepo: {repo_path}"
    
    r = think(scout_prompt, system=scout_system, tools=["search", "read_lines", "find_files", "list_dir", "shell"], model="claude-sonnet-4-20250514", conversation=[])
    
    scout_response = ""
    if r["has_tool_calls"]:
        result = exec(r, tools=["search", "read_lines", "find_files", "list_dir", "shell"], max_turns=12, system=scout_system, model="claude-sonnet-4-20250514")
        scout_response = result["content"]
    else:
        scout_response = r["content"]
    
    # If scout returned empty, do a quick grep-based exploration
    if scout_response.strip().length < 50:
        write(stdout, "Scout returned minimal findings. Doing quick grep exploration...")
        py_files = shell(f"cd {repo_path} && find . -maxdepth 3 -type f -name '*.py' | head -30")
        # Extract key terms from issue for grep
        quick_search = think(f"From this bug report, give me 3 grep patterns (one per line, no explanation) to find the relevant code:\n{issue}", model="claude-sonnet-4-20250514")
        patterns = quick_search.strip().split("\n")
        grep_results = ""
        for pattern in patterns:
            pattern = pattern.strip()
            if pattern.length > 0:
                grep_out = shell(f"cd {repo_path} && grep -rnE '{pattern}' --include='*.py' | head -10")
                grep_results = grep_results + f"\nPattern '{pattern}':\n{grep_out}\n"
        
        # Read the most relevant file sections
        relevant_lines = think(f"From these grep results, which file and line numbers should I read? Give me: FILE:path LINE:start-end\n{grep_results}", model="claude-sonnet-4-20250514")
        scout_response = f"Grep exploration:\n{grep_results}\n\nRelevant:\n{relevant_lines}"
    
    write(stdout, f"\nScout found:\n{scout_response}")
    
    # ========================================
    # PHASE 1.5: DISTILL (compress into dossier)
    # ========================================
    write(stdout, "\n=== Phase 1.5: Distill ===")
    
    # Separate think() call to extract structured info from scout's exploration
    # This is the "context window reset" — fresh call with just the scout's findings
    dossier = think(f"Extract a structured dossier from these findings about a bug.\n\nBug report:\n{issue}\n\nScout findings:\n{scout_response}\n\nOutput EXACTLY this format:\nFILE: <absolute file path>\nLINES: <start-end line numbers>\nCURRENT_CODE:\n<exact code from the file that needs changing>\nEND_CODE\nDIAGNOSIS: <what causes the bug>\nFIX: <exactly what to change>", model="claude-sonnet-4-20250514")
    
    write(stdout, f"\nDossier:\n{dossier}")
    
    # ========================================
    # PHASE 2: ARCHITECT (generate fix)
    # ========================================
    write(stdout, "\n=== Phase 2: Architect ===")
    
    grammar = read_text("prompts/cognos-flow-generator.md")
    
    architect_prompt = f"Write a Cognos flow called `solve` to fix this bug.\n\nDossier:\n{dossier}\n\nRules:\n- flow solve() -> String:\n- Available: shell(), write_text(path, content), read_file(), read_lines(), edit_file(path, old, new), git_diff()\n- Do NOT use think(). Do NOT use import.\n- BEST approach: Write a Python fix script:\n    write_text(\"/tmp/fix.py\", python_code)\n    shell(\"python3 /tmp/fix.py\")\n  The Python script reads the file, does exact string.replace(old, new), writes it back.\n- CRITICAL: Use ONLY double-quoted strings. Triple quotes must be \"\"\" not '''. Cognos does NOT support single quotes.\n- Repo: {repo_path}\n- End with: return git_diff()\n- Keep under 15 lines.\n\nReturn ONLY Cognos source. Use ONLY double quotes (no single quotes, no '''). No markdown fences. No ```."
    
    generated_code = think(architect_prompt, system=grammar, model="claude-sonnet-4-20250514")
    
    # Strip fences
    if "```" in generated_code:
        lines = generated_code.split("\n")
        clean = []
        for line in lines:
            stripped = line.strip()
            if stripped.length >= 3:
                if stripped[:3] == "```":
                    log("Stripped fence")
                else:
                    clean = clean + [line]
            else:
                clean = clean + [line]
        generated_code = clean.join("\n")
    
    generated_code = generated_code.strip()
    # Fix single-quoted strings (Cognos only supports double quotes)
    write_text("/tmp/cognos-code-raw.txt", generated_code)
    write_text("/tmp/cognos-fix-quotes.py", "c=open('/tmp/cognos-code-raw.txt').read()\nc=c.replace(\"'''\", '\"\"\"')\nopen('/tmp/cognos-code-raw.txt','w').write(c)")
    shell("python3 /tmp/cognos-fix-quotes.py")
    generated_code = read_text("/tmp/cognos-code-raw.txt").strip()
    write_text("/tmp/cognos-generated-flow.cog", generated_code)
    write(stdout, f"\nGenerated:\n{generated_code}")
    
    # ========================================
    # PHASE 3: EXECUTE (with retry)
    # ========================================
    write(stdout, "\n=== Phase 3: Execute ===")
    
    attempt = 0
    loop:
        if attempt >= 3:
            write(stdout, "Flow failed 3x. Falling back to agent mode...")
            shell(f"cd {repo_path} && git checkout -- . && git clean -fd 2>/dev/null")
            
            fb_system = f"Fix the bug. Tools: shell, read_file, read_lines, edit_file, search, find_files, git_diff.\nRepo: {repo_path}\nDo it in under 15 turns."
            fb_prompt = f"Fix this bug. Scout already found it:\n\n{dossier}\n\nOriginal:\n{issue}\n\nMake the edit and git_diff()."
            
            r2 = think(fb_prompt, system=fb_system, tools=["shell", "read_file", "read_lines", "edit_file", "search", "find_files", "git_diff"], model="claude-sonnet-4-20250514", conversation=[])
            if r2["has_tool_calls"]:
                exec(r2, tools=["shell", "read_file", "read_lines", "edit_file", "search", "find_files", "git_diff"], max_turns=15, system=fb_system, model="claude-sonnet-4-20250514")
            break
        
        attempt = attempt + 1
        write(stdout, f"\n--- Attempt {attempt}/3 ---")
        
        try:
            eval(generated_code)
            diff = invoke("solve", {})
            
            if diff.strip() == "":
                write(stdout, "Empty diff.")
                shell(f"cd {repo_path} && git checkout -- . && git clean -fd 2>/dev/null")
                if attempt < 3:
                    generated_code = think(f"Flow produced empty diff.\n\nDossier:\n{dossier}\n\nYour flow:\n{generated_code}\n\nRewrite. Use edit_file or write a Python script. Return ONLY Cognos source. Use ONLY double quotes (no single quotes, no ''').", system=grammar, model="claude-sonnet-4-20250514")
                    if "```" in generated_code:
                        l2 = generated_code.split("\n")
                        c2 = []
                        for l in l2:
                            s = l.strip()
                            if s.length >= 3:
                                if s[:3] != "```":
                                    c2 = c2 + [l]
                            else:
                                c2 = c2 + [l]
                        generated_code = c2.join("\n")
                    generated_code = generated_code.strip()
                    write_text("/tmp/cognos-generated-flow.cog", generated_code)
            else:
                write(stdout, "\n--- PATCH ---")
                write(stdout, diff)
                write(stdout, "--- END PATCH ---")
                return diff
        catch e:
            write(stdout, f"Error: {e}")
            shell(f"cd {repo_path} && git checkout -- . && git clean -fd 2>/dev/null")
            if attempt < 3:
                generated_code = think(f"Flow crashed: {e}\n\nDossier:\n{dossier}\n\nFlow:\n{generated_code}\n\nFix it. Use write_text + shell('python3 /tmp/fix.py') pattern. Return ONLY Cognos source. Use ONLY double quotes (no single quotes, no ''').", system=grammar, model="claude-sonnet-4-20250514")
                if "```" in generated_code:
                    l3 = generated_code.split("\n")
                    c3 = []
                    for l in l3:
                        s = l.strip()
                        if s.length >= 3:
                            if s[:3] != "```":
                                c3 = c3 + [l]
                        else:
                            c3 = c3 + [l]
                    generated_code = c3.join("\n")
                generated_code = generated_code.strip()
                write_text("/tmp/cognos-generated-flow.cog", generated_code)
    
    diff = git_diff()
    write(stdout, "\n--- PATCH ---")
    write(stdout, diff)
    write(stdout, "--- END PATCH ---")
    return diff
