flow exec(response: Map, tools: List = [], max_turns: Int = 20, system: String = "", model: String = "claude-sonnet-4-20250514") -> Map:
    "Multi-turn agentic tool loop with conversation history.
     Uses native Anthropic conversation API. Truncates tool results to stay within context limits."
    
    current = response
    turn = 0
    conversation = current["conversation"]
    
    loop:
        if turn >= max_turns:
            break
        if current["has_tool_calls"] == false:
            break
        
        # Execute all tool calls and build tool_results
        results = []
        for call in current["tool_calls"]:
            name = call["name"]
            args = call["arguments"]
            call_id = call["id"]
            result = invoke(name, args)
            result_str = f"{result}"
            # Truncate large results to keep conversation manageable
            if result_str.length > 2000:
                result_str = result_str[:2000] + "\n...(truncated)"
            results = results + [{"tool_use_id": call_id, "content": result_str}]
        
        # Prune old conversation to stay under token limits
        # Keep first 2 messages (user prompt + assistant response) and last 10 messages
        if conversation.length > 14:
            first = [conversation[0], conversation[1]]
            rest = conversation[conversation.length - 10:]
            conversation = first + rest
        
        # Send tool results back with conversation history
        current = think(
            "",
            model=model,
            tools=tools,
            system=system,
            conversation=conversation,
            tool_results=results
        )
        conversation = current["conversation"]
        turn = turn + 1
    
    return {"content": current["content"], "has_tool_calls": false, "turns": turn}
