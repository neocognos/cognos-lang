flow exec(response: Map, tools: List = [], max_turns: Int = 20, system: String = "", model: String = "claude-sonnet-4-20250514") -> Map:
    "Agentic tool loop: run tool calls, feed results back to LLM, repeat.
     Keeps first turn + last N turns for context. Urgency escalation prevents infinite searching."
    
    current = response
    turn = 0
    history = []
    
    loop:
        if turn >= max_turns:
            break
        if current["has_tool_calls"] == false:
            break
        
        # Execute all tool calls
        tool_results = []
        for call in current["tool_calls"]:
            name = call["name"]
            args = call["arguments"]
            result = invoke(name, args)
            result_str = f"{result}"
            if result_str.length > 1500:
                result_str = result_str[:1500] + "\n...(truncated)"
            tool_results = tool_results + [f"[{name}]: {result_str}"]
        
        tool_output = tool_results.join("\n")
        
        # Keep first turn + last 5 turns (total max 6)
        history = history + [f"Turn {turn + 1}:\n{tool_output}"]
        if history.length > 6:
            first = [history[0]]
            rest = history[history.length - 5:]
            history = first + rest
        
        context = history.join("\n---\n")
        
        # Urgency escalation
        urgency = ""
        if turn >= 8:
            urgency = f"\n\nYou have used {turn + 1} of {max_turns} turns. Prioritize making edits over more searching."
        if turn >= 12:
            urgency = f"\n\nURGENT: Turn {turn + 1}/{max_turns}. Make your edit NOW with edit_file(). You have enough information."
        
        current = think(
            f"Previous results:\n{context}{urgency}\n\nContinue working. Use tools if needed, or provide your final answer.",
            model=model,
            tools=tools,
            system=system
        )
        turn = turn + 1
    
    return {"content": current["content"], "has_tool_calls": false, "turns": turn}
