flow exec(response: Map, tools: List = [], max_turns: Int = 5, system: String = "Continue your task. Use tools if needed, or provide your final answer.", model: String = "deepseek-chat") -> Map:
    "Execute tool calls from a think() response in an agentic loop.
     Runs tool calls, feeds results back to the LLM, repeats until
     the LLM responds without tool calls or max_turns is reached.
     Keeps only last 2 turns of context to avoid confusion."
    
    current = response
    turn = 0
    prev_context = ""
    
    loop:
        if turn >= max_turns:
            break
        if current["has_tool_calls"] == false:
            break
        
        # Execute all tool calls
        tool_summary = ""
        for call in current["tool_calls"]:
            name = call["name"]
            args = call["arguments"]
            result = invoke(name, args)
            # Truncate large results
            result_str = f"{result}"
            if result_str.length > 2000:
                result_str = result_str[:2000] + "\n... (truncated)"
            tool_summary = tool_summary + f"\n[{name} returned]:\n{result_str}\n"
        
        # Only keep the latest tool results (not full history) to avoid context bloat
        prev_context = f"Tool results from turn {turn + 1}:{tool_summary}"
        
        # Call LLM again with just the latest results
        current = think(
            f"{prev_context}\n\nBased on these results, continue your task. Use tools if you need more info, or provide your final answer.",
            model=model,
            tools=tools,
            system=system
        )
        turn = turn + 1
    
    return {"content": current["content"], "has_tool_calls": false, "turns": turn}
