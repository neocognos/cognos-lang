flow exec(response: Map, tools: List = [], max_turns: Int = 20, system: String = "", model: String = "claude-sonnet-4-20250514") -> Map:
    "Multi-turn agentic tool loop with conversation history.
     Uses native Anthropic conversation API. Truncates tool results aggressively to prevent context overflow."
    
    current = response
    turn = 0
    conversation = current["conversation"]
    
    loop:
        if turn >= max_turns:
            break
        if current["has_tool_calls"] == false:
            break
        
        # Execute all tool calls and build tool_results
        results = []
        for call in current["tool_calls"]:
            name = call["name"]
            args = call["arguments"]
            # id may not exist for non-Anthropic APIs
            call_id = ""
            try:
                call_id = call["id"]
            catch e:
                call_id = f"call_{turn}_{name}"
            result = invoke(name, args)
            result_str = f"{result}"
            # Truncate to prevent context overflow, but keep enough for code edits
            if result_str.length > 4000:
                result_str = result_str[:2000] + f"\n\n... ({result_str.length} chars total, truncated) ...\n\n" + result_str[result_str.length - 1000:]
            results = results + [{"tool_use_id": call_id, "content": result_str}]
        
        # Send tool results back with conversation history
        current = think(
            "",
            model=model,
            tools=tools,
            system=system,
            conversation=conversation,
            tool_results=results
        )
        conversation = current["conversation"]
        turn = turn + 1
    
    return {"content": current["content"], "has_tool_calls": false, "turns": turn}
