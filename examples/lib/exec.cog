flow exec(response: Map, tools: List = [], max_turns: Int = 20, system: String = "", model: String = "claude-sonnet-4-20250514") -> Map:
    "Multi-turn agentic tool loop with conversation history.
     Uses native Anthropic conversation API. Truncates tool results aggressively to prevent context overflow."
    
    current = response
    turn = 0
    conversation = current["conversation"]
    
    loop:
        if turn >= max_turns:
            break
        if current["has_tool_calls"] == false:
            break
        
        # Execute all tool calls and build tool_results
        results = []
        for call in current["tool_calls"]:
            name = call["name"]
            args = call["arguments"]
            call_id = call["id"]
            result = invoke(name, args)
            result_str = f"{result}"
            # Aggressive truncation to prevent context overflow
            # read_file and search can return huge results
            if result_str.length > 800:
                # Keep first 400 and last 200 chars with indicator
                result_str = result_str[:400] + f"\n\n... ({result_str.length} chars total, truncated) ...\n\n" + result_str[result_str.length - 200:]
            results = results + [{"tool_use_id": call_id, "content": result_str}]
        
        # Send tool results back with conversation history
        current = think(
            "",
            model=model,
            tools=tools,
            system=system,
            conversation=conversation,
            tool_results=results
        )
        conversation = current["conversation"]
        turn = turn + 1
    
    return {"content": current["content"], "has_tool_calls": false, "turns": turn}
