# validated_think â€” think() with auto-retry on schema validation failure
#
# Usage:
#   import "lib/validated_think.cog"
#   result = validated_think("review this code",
#       format="Review", model="claude-sonnet-4-20250514", system="Be thorough.")

flow validated_think(input: String, format: String, model: String, system: String) -> Map:
    "Think with strict schema validation and auto-retry on failure."
    last_error = ""
    loop max=3:
        try:
            if last_error == "":
                return think(input, format=format, model=model, system=system)
            else:
                return think(last_error, format=format, model=model,
                    system="Fix the JSON to match the required schema exactly.")
        catch err:
            last_error = f"{err}"
    return {"_error": last_error}
