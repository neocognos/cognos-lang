# validated_think — think() with auto-retry on schema validation failure
#
# Usage:
#   import "lib/validated_think.cog"
#   result = validated_think("review this code", format="Review",
#       model="claude-sonnet-4-20250514", fix_model="qwen2.5:1.5b")
#
# On validation failure, sends the error + bad response to fix_model
# to correct the structure. Cheap model is enough — just fixing JSON.

flow validated_think(input: String, format: String, model: String, system: String, fix_model: String) -> Map:
    "Think with strict schema validation. Uses fix_model for retries."
    # First attempt: main model
    try:
        return think(input, format=format, model=model, system=system)
    catch first_error:
        pass

    # Retries: use fix_model (cheap, fast — just fixing structure)
    last_error = f"{first_error}"
    loop max=2:
        try:
            return think(last_error, format=format, model=fix_model, system="Fix the JSON to match the required schema exactly.")
        catch err:
            last_error = f"{err}"
    return {"_error": last_error}
