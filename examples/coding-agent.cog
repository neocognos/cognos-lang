# coding-agent.cog — Autonomous coding agent for resolving GitHub issues
# Run: cognos run --memory --allow-shell examples/coding-agent.cog
#
# Single-phase design: one tool loop handles explore → plan → edit → verify

import "lib/exec.cog"

# --- Tool flows (available to think()) ---

flow shell(command: String) -> String:
    "Run a shell command. Use for grep, sed, git, python3, etc."
    return __exec_shell__(command)

flow read_file(path: String) -> String:
    "Read a file. Path is relative to the repo root."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && cat {path}")

flow read_lines(path: String, start: Int, end: Int) -> String:
    "Read specific lines from a file (1-indexed)"
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && sed -n '{start},{end}p' {path}")

flow search(pattern: String, path: String = ".") -> String:
    "Grep for a pattern in Python files. Returns matching lines with file:line prefix."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && grep -rn '{pattern}' {path} --include='*.py' | head -50")

flow find_files(pattern: String) -> String:
    "Find files matching a glob pattern"
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && find . -name '{pattern}' -not -path './.git/*' | head -30")

flow list_dir(path: String = ".") -> String:
    "List directory contents"
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && ls -la {path}")

flow edit_file(path: String, old_text: String, new_text: String) -> String:
    "Replace old_text with new_text in a file. Use for surgical edits. old_text must match exactly."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    full_path = f"{repo}/{path}"
    # Save old/new text to temp files, use python3 for reliable replacement
    write_text("/tmp/cognos-old.txt", old_text)
    write_text("/tmp/cognos-new.txt", new_text)
    write_text("/tmp/cognos-edit.py", "import sys\nwith open(sys.argv[1]) as f: content = f.read()\nwith open('/tmp/cognos-old.txt') as f: old = f.read()\nwith open('/tmp/cognos-new.txt') as f: new = f.read()\nif old not in content: print('ERROR: old_text not found'); sys.exit(1)\ncontent = content.replace(old, new, 1)\nwith open(sys.argv[1], 'w') as f: f.write(content)\nprint('OK: edited ' + sys.argv[1])")
    return __exec_shell__(f"python3 /tmp/cognos-edit.py {full_path}")

flow git_diff() -> String:
    "Show current uncommitted changes as unified diff"
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && git diff")

# --- Main agent ---

flow solve(issue: String, repo_path: String, test_cmd: String = "python3 -m pytest") -> String:
    "Solve a GitHub issue using a single tool loop"
    
    # Get repo structure for initial context
    dirs = shell(f"cd {repo_path} && find . -maxdepth 2 -type f -name '*.py' | head -30")
    top = shell(f"cd {repo_path} && ls -la")
    
    system_prompt = f"You are an expert software engineer fixing a bug in a Python repository.\n\nRepository: {repo_path}\nTop-level files:\n{top}\n\nPython files:\n{dirs}\n\nYOUR TASK: Fix the bug described below. Follow these steps:\n1. SEARCH for relevant code using search() and read_file()/read_lines()\n2. UNDERSTAND the bug — find the exact file and line causing the issue\n3. EDIT the code using edit_file(path, old_text, new_text) — be precise with old_text\n4. VERIFY your fix with git_diff() to confirm the change looks correct\n\nIMPORTANT RULES:\n- Use search() to find relevant code, don't guess file paths\n- Use read_lines() to read specific sections, not entire large files\n- Use edit_file() for edits — provide exact old_text that exists in the file\n- After editing, ALWAYS call git_diff() to verify\n- When done, say DONE and summarize what you changed\n\nBug report:\n{issue}"

    r = think(
        f"Find and fix this bug. Start by using search() to find relevant code.\n\nBug report:\n{issue}",
        model="deepseek-chat",
        tools=["shell", "read_file", "read_lines", "search", "find_files", "list_dir", "edit_file", "git_diff"],
        system=system_prompt
    )
    
    if r.has_tool_calls:
        result = exec(r, 
            tools=["shell", "read_file", "read_lines", "search", "find_files", "list_dir", "edit_file", "git_diff"],
            model="deepseek-chat",
            max_turns=12,
            system=system_prompt
        )
    
    # Get final diff
    diff = shell(f"cd {repo_path} && git diff")
    return diff

flow main():
    issue = shell("cat /tmp/cognos-issue.txt 2>/dev/null")
    repo_path = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    
    if issue.strip() == "":
        write(stdout, "Enter issue (Ctrl+D to end):")
        issue = read(stdin)
        if issue == none:
            return none
        write(stdout, "Enter repo path:")
        repo_path = read(stdin)
        if repo_path == none:
            repo_path = "."
        repo_path = repo_path.strip()
    
    write(stdout, f"Solving issue in {repo_path}...")
    
    diff = solve(issue, repo_path)
    
    write(stdout, "\n--- PATCH ---")
    write(stdout, diff)
    write(stdout, "--- END PATCH ---")
