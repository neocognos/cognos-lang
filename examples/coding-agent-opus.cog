# coding-agent.cog — Autonomous coding agent for resolving GitHub issues
# Run: cognos run --memory --allow-shell examples/coding-agent.cog
#
# Single-phase design: one tool loop handles explore → plan → edit → verify

import "lib/exec.cog"

# --- Tool flows (available to think()) ---

flow shell(command: String) -> String:
    "Run a shell command. Use for grep, sed, git, python3, etc."
    return __exec_shell__(command)

flow read_file(path: String) -> String:
    "Read a file. Path is relative to the repo root."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && cat {path}")

flow read_lines(path: String, start: Int, end: Int) -> String:
    "Read specific lines from a file (1-indexed)"
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && sed -n '{start},{end}p' {path}")

flow search(pattern: String, path: String = ".") -> String:
    "Grep for a pattern in Python files. Returns matching lines with file:line prefix."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && grep -rnE '{pattern}' {path} --include='*.py' | head -50")

flow find_files(pattern: String) -> String:
    "Find files matching a glob pattern"
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && find . -name '{pattern}' -not -path './.git/*' | head -30")

flow list_dir(path: String = ".") -> String:
    "List directory contents"
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && ls -la {path}")

flow edit_file(path: String, old_text: String, new_text: String) -> String:
    "Replace old_text with new_text in a file. Use for surgical edits. old_text must match exactly."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    full_path = f"{repo}/{path}"
    # Save old/new text to temp files, use python3 for reliable replacement
    write_text("/tmp/cognos-old.txt", old_text)
    write_text("/tmp/cognos-new.txt", new_text)
    write_text("/tmp/cognos-edit.py", "import sys\nwith open(sys.argv[1]) as f: content = f.read()\nwith open('/tmp/cognos-old.txt') as f: old = f.read()\nwith open('/tmp/cognos-new.txt') as f: new = f.read()\nif old not in content: print('ERROR: old_text not found'); sys.exit(1)\ncontent = content.replace(old, new, 1)\nwith open(sys.argv[1], 'w') as f: f.write(content)\nprint('OK: edited ' + sys.argv[1])")
    return __exec_shell__(f"python3 /tmp/cognos-edit.py {full_path}")

flow git_diff() -> String:
    "Show current uncommitted changes as unified diff"
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && git diff")

flow note(fact: String) -> String:
    "Save an important finding to memory (survives context window). Use this to remember key code locations, root causes, and plans."
    remember(fact)
    return f"Noted: {fact}"

flow notes(query: String) -> String:
    "Search your saved notes/findings by meaning. Use this to retrieve what you found earlier."
    results = recall(query)
    return results

# --- Main agent ---

flow solve(issue: String, repo_path: String, test_cmd: String = "python3 -m pytest") -> String:
    "Solve a GitHub issue using a single tool loop"
    
    # Get repo structure for initial context
    dirs = shell(f"cd {repo_path} && find . -maxdepth 2 -type f -name '*.py' | head -30")
    top = shell(f"cd {repo_path} && ls -la")
    
    system_prompt = f"You are an expert software engineer. Fix the bug described below.\n\nRepository: {repo_path}\nTop-level files:\n{top}\n\nPython files:\n{dirs}\n\nYou work in two phases:\n1. EXPLORE: Use search() and read_file() to find the relevant source code. Focus on understanding the bug in the current codebase — do NOT look at git history or commits. Use note() to save key findings. When you know exactly what to edit, respond with just READY.\n2. EDIT: Make surgical fixes with edit_file(). Then git_diff() to verify.\n\nIMPORTANT: The fix should be a minimal code change. Do NOT look at git log/blame/diff — focus on reading the source code and understanding the bug.\n\nBug report:\n{issue}"

    r = think(
        f"Fix this bug:\n\n{issue}",
        model="claude-opus-4-6",
        tools=["shell", "read_file", "read_lines", "search", "find_files", "list_dir", "edit_file", "git_diff", "note", "notes"],
        system=system_prompt,
        conversation=[]
    )
    
    if r.has_tool_calls:
        result = exec(r, 
            tools=["shell", "read_file", "read_lines", "search", "find_files", "list_dir", "edit_file", "git_diff", "note", "notes"],
            model="claude-opus-4-6",
            max_turns=20,
            system=system_prompt
        )
    
    # Get final diff
    diff = shell(f"cd {repo_path} && git diff")
    return diff

flow main():
    issue = shell("cat /tmp/cognos-issue.txt 2>/dev/null")
    repo_path = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    
    if issue.strip() == "":
        write(stdout, "Enter issue (Ctrl+D to end):")
        issue = read(stdin)
        if issue == none:
            return none
        write(stdout, "Enter repo path:")
        repo_path = read(stdin)
        if repo_path == none:
            repo_path = "."
        repo_path = repo_path.strip()
    
    write(stdout, f"Solving issue in {repo_path}...")
    
    diff = solve(issue, repo_path)
    
    write(stdout, "\n--- PATCH ---")
    write(stdout, diff)
    write(stdout, "--- END PATCH ---")
