# meta-agent.cog — Master LLM generates task-specific Cognos flows
# Run: cognos run --memory --allow-shell examples/meta-agent.cog

import "lib/exec.cog"

# --- Tool flows available to generated code ---

flow shell(command: String) -> String:
    "Run a shell command."
    return __exec_shell__(command)

flow read_file(path: String) -> String:
    "Read a file. Path is relative to the repo root."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && cat {path}")

flow read_lines(path: String, start: Int, end: Int) -> String:
    "Read specific lines from a file (1-indexed)"
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && sed -n '{start},{end}p' {path}")

flow search(pattern: String, path: String = ".") -> String:
    "Grep for a pattern in Python files."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && grep -rnE '{pattern}' {path} --include='*.py' | head -50")

flow find_files(pattern: String) -> String:
    "Find files matching a glob pattern"
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && find . -name '{pattern}' -not -path './.git/*' | head -30")

flow list_dir(path: String = ".") -> String:
    "List directory contents"
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && ls -la {path}")

flow edit_file(path: String, old_text: String, new_text: String) -> String:
    "Replace old_text with new_text in a file. old_text must match exactly."
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    # Support both absolute and relative paths
    if path[:1] == "/":
        full_path = path
    else:
        full_path = f"{repo}/{path}"
    write_text("/tmp/cognos-old.txt", old_text)
    write_text("/tmp/cognos-new.txt", new_text)
    write_text("/tmp/cognos-edit.py", "import sys\nwith open(sys.argv[1]) as f: content = f.read()\nwith open('/tmp/cognos-old.txt') as f: old = f.read()\nwith open('/tmp/cognos-new.txt') as f: new = f.read()\nif old not in content:\n    print('ERROR: old_text not found in ' + sys.argv[1] + ' | Looking for: ' + repr(old[:200]))\nelse:\n    content = content.replace(old, new, 1)\n    with open(sys.argv[1], 'w') as f: f.write(content)\n    print('OK: edited ' + sys.argv[1])")
    result = __exec_shell__(f"python3 /tmp/cognos-edit.py {full_path}")
    if "ERROR" in result:
        log(f"edit_file failed: {result}")
    return result

flow git_diff() -> String:
    "Show current uncommitted changes as unified diff"
    repo = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    return __exec_shell__(f"cd {repo} && git diff")

flow note(key: String, value: String) -> String:
    "Store a note for later reference"
    remember(f"{key}: {value}")
    return f"Noted: {key}"

# --- Master agent ---

flow main():
    issue = shell("cat /tmp/cognos-issue.txt 2>/dev/null")
    repo_path = shell("cat /tmp/cognos-repo.txt 2>/dev/null || echo '.'").strip()
    
    if issue.strip() == "":
        write(stdout, "Enter issue (Ctrl+D to end):")
        issue = read(stdin)
        if issue == none:
            return none
        write(stdout, "Enter repo path:")
        repo_path = read(stdin)
        if repo_path == none:
            repo_path = "."
        repo_path = repo_path.strip()
    
    write(stdout, f"Meta-agent: analyzing task...")
    
    # --- Flow caching: recall similar past solutions ---
    cached_flow = ""
    prior = recall(f"cognos-flow: {issue[:200]}")
    if prior != none:
        if prior.strip() != "":
            write(stdout, "Found cached flow from similar task — will use as reference.")
            cached_flow = prior
    
    # Gather repo context for the master
    dirs = shell(f"cd {repo_path} && find . -maxdepth 3 -type f -name '*.py' | head -40")
    top = shell(f"cd {repo_path} && ls -la")
    
    # Load the Cognos grammar
    grammar = read_text("prompts/cognos-flow-generator.md")
    
    # Ask the master LLM to generate a task-specific flow
    # Include cached flow reference if available
    cache_hint = ""
    if cached_flow != "":
        cache_hint = f"\n\nHere is a previously successful flow for a similar task — adapt it, don't copy blindly:\n{cached_flow}\n"
    
    master_prompt = f"Write a Cognos flow called `solve` that fixes this bug.{cache_hint}\n\nCritical rules:\n- flow solve() -> String: (no parameters)\n- Do NOT use import — all tools are already available\n- think() ALWAYS returns a Map — use result[\"content\"] to get the string\n- ALWAYS pass model=\"claude-sonnet-4-20250514\" to think()\n- edit_file(path, old_text, new_text) — old_text must match EXACTLY including whitespace/indentation. path is ABSOLUTE.\n- NEVER hardcode old_text from the bug report. The report may describe old code versions.\n- Pattern: 1) read_lines to get exact current code 2) use think() to determine what to change 3) pass exact text from the file to edit_file\n- The old_text MUST be copied from actual file content, not from memory or the bug report\n- End with: return git_diff()\n- Repo path: {repo_path}\n\nTop-level:\n{top}\n\nPython files:\n{dirs}\n\nBug report:\n{issue}\n\nReturn ONLY the Cognos flow source code. No markdown fences, no explanation."

    result = think(master_prompt, system=grammar, model="claude-opus-4-6")
    generated_code = result["content"]
    
    # Strip markdown fences if present
    if "```" in generated_code:
        lines = generated_code.split("\n")
        clean_lines = []
        for line in lines:
            if line.strip()[:3] != "```":
                clean_lines = clean_lines + [line]
        generated_code = "\n".join(clean_lines)
    
    # Save the generated flow for inspection
    write_text("/tmp/cognos-generated-flow.cog", generated_code)
    write(stdout, f"\n--- Generated Flow (saved to /tmp/cognos-generated-flow.cog) ---")
    write(stdout, generated_code)
    write(stdout, "--- End Generated Flow ---\n")
    
    # Execute with retry — if it fails, feed error back to master
    attempt = 0
    max_attempts = 3
    diff = ""
    
    loop:
        if attempt >= max_attempts:
            write(stdout, "All attempts failed.")
            break
        
        attempt = attempt + 1
        write(stdout, f"\n=== Attempt {attempt}/{max_attempts} ===")
        write(stdout, "Executing generated flow...")
        
        try:
            eval(generated_code)
            diff = invoke("solve", {})
            write(stdout, "\n--- PATCH ---")
            write(stdout, diff)
            write(stdout, "--- END PATCH ---")
            
            # Cache successful flow for future reuse
            summary = issue[:200].replace("\n", " ")
            remember(f"cognos-flow: {summary}\n---\n{generated_code}")
            write(stdout, "Flow cached in memory for future reuse.")
            break
        catch e:
            error_msg = f"{e}"
            write(stdout, f"Failed: {error_msg}")
            
            if attempt < max_attempts:
                write(stdout, "Asking master to fix the flow...")
                # Reset repo
                shell(f"cd {repo_path} && git checkout -- .")
                
                retry_prompt = f"Your generated Cognos flow failed with this error:\n\n{error_msg}\n\nHere was your flow:\n{generated_code}\n\nFix the error and return the corrected flow. Remember:\n- think() ALWAYS returns a Map — use result[\"content\"] to get the string\n- Do NOT use import\n- edit_file(path, old_text, new_text) needs exact matching text\n- All tool flows are already available\n- Do NOT wrap output in markdown fences\n\nReturn ONLY the corrected Cognos flow source code. No markdown, no explanation."
                retry_result = think(retry_prompt, system=grammar, model="claude-opus-4-6")
                generated_code = retry_result["content"]
                # Strip markdown fences if present
                if "```" in generated_code:
                    lines = generated_code.split("\n")
                    clean_lines = []
                    for line in lines:
                        if line.strip()[:3] != "```":
                            clean_lines = clean_lines + [line]
                    generated_code = "\n".join(clean_lines)
                write_text("/tmp/cognos-generated-flow.cog", generated_code)
                write(stdout, f"\n--- Revised Flow ---")
                write(stdout, generated_code)
                write(stdout, "--- End Revised Flow ---")
